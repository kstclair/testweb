---
title: "Optimal sample size allocation"
author: "Stat 260, St. Clair"
subtitle: "Week 4 (3.4)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(collapse=TRUE, prompt=TRUE, comment=NULL, message = FALSE, warning = FALSE, fig.height = 7, fig.width = 11)
library(dplyr)
library(knitr)
```


## Determining sample sizes for a stratified sample

.large[
**Problem:** You have a quantitative variable $y$ and you want to estimate its population mean/total with precision.
]

<br>

--

.large[
**Question 1:** If I sample $n$ units total, what fraction of these units should be taken from stratum $h$?

<br>
<br>


**Solution 1:** Determine the **allocation fraction** $a_{h}$ for each stratum.
$$
a_h = \dfrac{n_h}{n}
$$
]

---



## Determining sample sizes for a stratified sample

.large[
**Problem:** You have a quantitative variable $y$ and you want to estimate its population mean/total with precision.
]

<br>

--
.large[
**(Optional) Question 2:** How many units  should be selected to **either** 

(a) achieve a desired margin of error or 

(b) not exceed by fixed survey budget?

<br>

<br>

**Solution 2:** Determine the total sample size $n$.
]

---

## Q1. Sample size allocation

.large[
**Goal:** Determine the allocation fractions $a_1, a_2, \dotsc, a_H$ for all strata to get sample sizes:
$$
n_h = n a_h
$$

- **Optimal allocation:** 
  
  (a) minimize cost (sample size) for a fixed margin of error **OR** 
  
  (b) minimize the margin of error for a fixed cost (sample size).

]

---

## Q1. Sample size allocation

.large[
**Goal:** Determine the allocation fractions $a_1, a_2, \dotsc, a_H$ for all strata to get sample sizes:
$$
n_h = n a_h
$$

- **Optimal allocation:** (a) minimize cost (sample size) for a fixed margin of error **OR** (b) minimize the margin of error for a fixed cost (sample size).

  - **Neyman allocation:**  special case of optimal when all stratum **costs** are the same. 

- **Proportional allocation:** $a_h = \dfrac{n_h}{n} = \dfrac{N_h}{N}$

  - This is optimal  when  stratum **costs** and **variances** are the same. 
  
    - Use if the stratum SDs $S_{h}$ are not known.

- Any other allocation that satisfies $\sum_{h=1}^H a_h = 1$.
]

---

## Q1. Optimal Allocation

.large[
This allocation is **optimal** because it 
- **minimizes costs** for a fixed SE/margin of error, *or* 
- **minimizes SE/margin of error**  for a fixed survey cost.

]
--

.large[
**Mathematical Problem:** 

- Let $c_{h}$ be the cost of sampling one unit from stratum $h$ and $c_{0}$ are your fixed costs.  Total survey costs are
$$C(\{a_h\}, n) = c_{0}+\sum_{h=1}^{H} c_{h}(na_{h})$$
- Variance is also a function of $\{a_h\}$ and $n$, e.g. variance for estimated mean:
$$V(\{a_h\}, n) = \sum_{h=1}^H \left( 1- \dfrac{na_h}{N_h}\right)\left(\dfrac{N_h}{N}\right)^2 \dfrac{S^2_h}{na_h}$$
]

---

## Q1. Optimal Allocation

.large[
**Solution:** Use Lagrange Multiplier method to minimize one function  ( $C$ or $V$) subject to the contraints of the other function.

- The optimal allocation fraction is
$$a_h = \dfrac{N_h S_h/\sqrt{c_h}}{\displaystyle\sum_{k=1}^H N_k S_k/\sqrt{c_k}}  \ \ \textrm{ where } S_{h} = \textrm{ pop. SD in stratum  } h$$


- Highest allocation for strata with 

  - high variability $S_{h}$, 
  
  - large size $N_{h}$, or 
  
  - low costs $c_{h}$.
]

---

## Q1. Neyman Allocation

.large[
Neyman allocation is an **optimal allocation** if you  assume the cost per observation are the same for all strata $c_1 = c_2 = \dotsm = c_H$.

- The Neyman allocation fraction is
$$a_h = \dfrac{N_h S_h}{\displaystyle\sum_{k=1}^H N_k S_k}$$

- Use this allocation if if costs $c_{h}$ are unknown. 
]

---

##  Q1. Proportional Allocation

.large[
Proportional allocation is an **optimal allocation** if the cost per observation and SDs are the same for all strata: 
- $c_1 = c_2 = \dotsm = c_H$ and
- $S_1 = S_2 = \dotsm= S_H$.

- The proportional allocation fraction is
$$a_h = \dfrac{N_h}{N}$$


- Use this allocation if you don't have good guesses of the within stratum SD's $S_{h}$ and costs are unknown or equal. 
    - May not be optimal, but it is usually better than SRS.

]

---

### 2. Determining total sample size: (a) achieving a margin of error

.large[
**Problem:** what is $n$  to estimate $\bar{y}_{\mathcal{U}}$ with $(1-\alpha)100\%$ confidence and a margin of error $e = z_{\alpha/2} SE(\bar{y}_{str})$?

**Solution:** Get allocations $a_h$'s, if you ignore the FPC then
$$n_{0} = \dfrac{ \nu z^{2}_{\alpha/2}}{e^{2}} \ \ \textrm{  where  }  \ \ \nu = \sum_{h=1}^{H} \left(\dfrac{N_{h}}{N}\right)^{2} \dfrac{S^{2}_{h}}{a_{h}}$$

- If your stratum population sizes are smaller, don't ignore FPC and use:
$$n = \dfrac{ n_{0}}{1+D} \textrm{ where } D = \dfrac{z_{\alpha/2}^{2} \sum_{h=1}^{H} N_{h}S^{2}_{h}}{N^{2}e^{2}}$$

- To estimate $t$ with $e_{t}$ margin of error, just set $e=e_{t}/N$.


- $\pmb{\star}$ If **optimal allocation** is used to determine $a_{h}$'s, then you will **minimize the cost** of achieving this margin of error.

]

---

### 2. Determining total sample size: (b) Do not go over budget

.large[

**Problem:** what is $n$ if your budget is $C$ dollars (or man hours, etc...)?

**Solution:** Get allocations $a_h$'s, then
$$n = \dfrac{C - c_{0}}{\displaystyle\sum_{h=1}^H c_h a_h}$$

- $\pmb{\star}$ If **optimal allocation** is used to determine $a_{h}$'s, then you will **minimize the SE** of your estimate (and M.E.) while not exceeding your fixed budget $C$.

]

---


## What about a Population Proportion?

.large[
- What if your variable of interest is categorical?
- All previous formulas apply  but let
$$S_h \approx \sqrt{p_h (1-p_h)}$$


---


## Example

Suppose we know this about our  population's heights:

```{r, echo=FALSE}
pop <- read.csv("http://math.carleton.edu/kstclair/data/StatsClassSurvey.csv")
pop.sex <- pop %>% group_by(Sex) %>%
  summarize(Nh = n(), pop.mean = mean(Height), pop.var = var(Height)) %>% 
  rename(strata = Sex)
kable(bind_rows(pop.sex),digits = 2) 
```

What is the optimal allocation of if you know that sampling from the male stratum will cost twice as much as sampling from the female stratum?

---


## Example

What are the optimal sample sizes if you want to sample a total of 40 people?

---


## Example

Suppose it costs $1 to sample from the female stratum. Compute the cost and SE for estimating the population mean using the optimal sample sizes when $n=40$. 

---


## Example

Compute the cost and SE for estimating the population mean using *proportional allocation* when $n=40$. 

---


## Example

If you want to fix costs at $59, what is the SE of the optimal allocation? (and compare to proportional allocation)

---


## Example

Suppose you want to estimate the average height in the population to within 0.5 inches with 95% confidence. Assuming that stratum costs are equal, what stratum sample sizes should you use?