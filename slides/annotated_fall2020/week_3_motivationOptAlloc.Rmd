---
title: "Motivation: optimal sample size allocation"
author: "Stat 260, St. Clair"
subtitle: "Week 3 (3.4)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(collapse=TRUE, prompt=TRUE, comment=NULL, message = FALSE, warning = FALSE, fig.height = 6, fig.width = 11)
library(dplyr)
library(ggplot2)
library(tidyr)
```

## Tradeoff: Cost vs. Precision

As $n$ (sample size) increases:
  
  - SE's get decrease (more precise) but
  
  - sampling costs increase

---

## SRS example

- $N = 3000$ units

- Assume $S = 1$ for our measurement of interest

<br>
<br>
<br>


**Cost:** costs per unit is $c =$ $2
$$\textrm{total cost} = C(n) = \$2n$$

<br>
<br>

**Precision:** 95% margin of error for estimating the mean 

$$ME(n) = 1.96 \times SE(\bar{y}_{srs}) = 1.96 \times \sqrt{\left(1-\frac{n}{3000} \right) \dfrac{1}{n}}$$

---

## SRS example: determine the $n$ that...

**Constraint:** ME of at most 0.2

**Optimize:** minimize cost under this constraint

```{r, echo = FALSE}
mydata <- tibble(n = 50:110)
mydata <- mydata %>%
  mutate(cost = 2*n, 
         margin_of_error = 1.96*sqrt((1-n/3000)/n))
ggplot(mydata, aes(x=n, y=margin_of_error, color=cost)) + 
  geom_point(size=2) +
  scale_color_gradient(low = "#bdc3c7", high="#2c3e50") +
  labs(title="Cost and ME as a function of sample size (n)") + 
  theme_minimal() + 
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"), 
        legend.text = element_text(size=16),
        legend.title = element_text(size=16),
        plot.title = element_text(size=16)) + 
  geom_hline(yintercept  = .2, linetype = "dashed")
  
```



---

## SRS example: determine the $n$ that...


**Constraint:** Costs of at most $200

**Optimize:** minimize margin of error (SE) under this constraint


```{r, echo = FALSE}
ggplot(mydata, aes(x=n, y=cost, color=margin_of_error)) + 
  geom_point(size=2) +
  scale_color_gradient(low = "#bdc3c7", high="#2c3e50") +
  labs(title="Cost and ME as a function of sample size (n)") + 
  theme_minimal() + 
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"), 
        legend.text = element_text(size=16),
        legend.title = element_text(size=16),
        plot.title = element_text(size=16)) + 
  geom_hline(yintercept  = 200, linetype = "dashed")
  
```

---

## Stratified problem:

Issue: **Both** costs and precision can depend on how we **allocate** our overall sample size to each stratum

- Strata may be more/less costly to sample

- Measurements within stratum may have different SDs $S_h$

<br>

- The **allocation** fraction for stratum $h$ is
$$
a_h = \dfrac{n_h}{n}
$$

- Must have $\sum_{h=1}^H a_h = 1$ 


---

## Stratified example

- $H = 3$ strata with $N_h = 1000$ and $S_h = 1$

<br>
<br>


**Cost:** costs per unit in each stratum are $c_1 =1, c_2 = 2, c_3 = 3$
$$\textrm{total cost} = C(n, a_1, a_2) = \$1a_1n + \$2a_2n +\$3(1-a_1-a_2)n$$

<br>
<br>

**Precision:** 95% margin of error for estimating the mean 

$$ME(n, a_1, a_2) =  1.96 \times \sqrt{\sum_{h=1}^3 \left( \dfrac{1000}{3000}\right)^2\left(1-\frac{a_hn}{1000} \right) \dfrac{1}{a_hn}}$$




---

## Stratified example: determine the $n, a_1, a_2$ that...

**Constraint:** Costs equal to $200

**Optimize:** minimize margin of error (SE) under this constraint

```{r, echo = FALSE}
mydata <- tibble(
  n = 50:150, 
  a1  = seq(0,1, by=.01), 
  a2 = seq(0,1, by=.01))
mydata <- expand(mydata, n, a1, a2)
mydata <- mydata %>% 
  mutate(a3 = 1- a1 - a2, 
         suma = a1 + a2 + a3) %>%
  filter(a3 > 0) 
mydata <- mydata %>%
  mutate(
    n1 = n*a1, 
    n2 = n*a2, 
    n3 = n*a3 ) %>%
  filter(n1 >=1, n2>=1, n3 >=1)
  
mydata <- mydata %>%
  mutate(cost = 1*n1 + 2*n2 + 3*n3, 
         margin_of_error = 1.96*(1/3)*sqrt((1-n1/1000)/n1  + (1-n2/1000)/n2 + (1-n3/1000)/n3))

ggplot(filter(mydata, n == 80), aes(x=a1,y=a2)) +
  geom_raster(aes(fill=margin_of_error))+
  scale_fill_gradient(low = "#bdc3c7", high="#2c3e50", trans="log", labels = scales::number_format(accuracy = 0.01), limits=c(min(mydata$margin_of_error),max(mydata$margin_of_error))) +
  labs(title="ME as a function of allocation a1 and a2 with n=80") + 
  theme_minimal() + 
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"), 
        legend.text = element_text(size=16),
        legend.title = element_text(size=16),
        plot.title = element_text(size=16)) 
```



---

## Stratified example: determine the $n, a_1, a_2$ that...

**Constraint:** Costs equal to $200


---

## Stratified example: determine the $n, a_1, a_2$ that...

**Constraint:** Costs equal to $200

**Optimize:** minimize margin of error (SE) under this constraint

```{r, echo = FALSE}
ggplot(filter(mydata, n == 80), aes(x=a1,y=a2)) +
  geom_raster(aes(fill=margin_of_error))+
  scale_fill_gradient(low = "#bdc3c7", high="#2c3e50", trans="log", labels = scales::number_format(accuracy = 0.01), limits=c(min(mydata$margin_of_error),max(mydata$margin_of_error))) +
  labs(title="ME as a function of allocation a1 and a2 with n=80",
       subtitle="line is solutions with cost equal to $200") + 
  theme_minimal() + 
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"), 
        legend.text = element_text(size=16),
        legend.title = element_text(size=16),
        plot.title = element_text(size=16))+
    geom_abline(intercept = (3-200/80), slope = -2, linetype = "dashed") 
```

---

## Stratified example: determine the $n, a_1, a_2$ that...

**Constraint:** Costs equal to $200

**Optimize:** minimize margin of error (SE) under this constraint

```{r, echo = FALSE}
ggplot(filter(mydata, n == 130), aes(x=a1,y=a2)) +
  geom_raster(aes(fill=margin_of_error))+
  scale_fill_gradient(low = "#bdc3c7", high="#2c3e50", trans="log", labels = scales::number_format(accuracy = 0.01), limits=c(min(mydata$margin_of_error),max(mydata$margin_of_error))) +
  labs(title="ME as a function of allocation a1 and a2 with n=130",
       subtitle="line is solutions with cost equal to $200") + 
  theme_minimal() + 
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"), 
        legend.text = element_text(size=16),
        legend.title = element_text(size=16),
        plot.title = element_text(size=16))+
    geom_abline(intercept = (3-200/130), slope = -2, linetype = "dashed") 
```

---

## Stratified example: determine the $n, a_1, a_2$ that...


**Constraint:** Costs equal to $200

**Optimize:** minimize margin of error (SE) under this constraint


```{r, echo = FALSE}
ggplot(filter(mydata, n == 110), aes(x=a1,y=a2)) +
  geom_raster(aes(fill=margin_of_error))+
  scale_fill_gradient(low = "#bdc3c7", high="#2c3e50", trans="log", labels = scales::number_format(accuracy = 0.01), limits=c(min(mydata$margin_of_error),max(mydata$margin_of_error))) +
  labs(title="ME as a function of allocation a1 and a2 with n=110",
       subtitle="line is solutions with cost equal to $200") + 
  theme_minimal() + 
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"), 
        legend.text = element_text(size=16),
        legend.title = element_text(size=16),
        plot.title = element_text(size=16))+
    geom_abline(intercept = (3-200/110), slope = -2, linetype = "dashed") +
  geom_point(aes(x=.437, y=.310), color="red")
```


---

## Stratified example: determine the $n, a_1, a_2$ that...


**Constraint:** Costs equal to $200

**Optimize:** minimize margin of error (SE) under this constraint

---