---
title: "Two-stage cluster sampling estimation"
author: "Stat 260, St. Clair"
subtitle: "Week 7 (5.3)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r, include=FALSE}
knitr::opts_chunk$set(collapse=TRUE, prompt=TRUE, comment=NULL,tidy.opts=list(width.cutoff=60),tidy=FALSE,eval=TRUE,eval=TRUE, warning=FALSE, message  = FALSE)
library(dplyr)
library(knitr)
library(survey)
```




## Design: One-Stage Cluster  Sample 

**Defined**: We take a SRS of $n$ **clusters** and survey **every observation unit** in selected clusters.


![](cluster_pic.jpg)

.footnote[https://spot.pcc.edu/~evega/section-4.html]

---


## Design: Two-Stage Cluster  Sample 


**Defined**: We take a **SRS of clusters** and take a **SRS of observation units** within each selected cluster.



![](multistage_pic.jpg)

.footnote[https://spot.pcc.edu/~evega/section-4.html]

---


## Design: Two-Stage Cluster  Sample 

- **Primary Sampling Units (PSU):** clusters
  
  - $N$ clusters in the population
  
  - $n$ number of clusters sampled

- **Secondary Sampling Units (SSU):** observation units

  - $y_{ij}$ is the measurement for unit $j$ in cluster $i$
  
  - $M_i$ is the number of observation units in cluster $i$
  
  - $m_i \leq M_i$ is the sampled observation units in cluster $i$
  
  - $M_0 = \sum_{i=1}^N M_i$ is the total number of observation units in the population



---

## Example: California API scores

- A SRS of 40 school districts was selected from the 757 districts in the state. `dname` gives district name and `dnum` is a numerical ID for each district.

- Data from a SRS of schools within each selected district was collected.    `sname` gives a 40 character name and `snum` gives a numerical ID for each school.



---

## Inclusion probabilities: Two-Stage Cluster 

What is the probability that unit $j$ from cluster $i$ is selected?
 

---

## Sampling weights:  Two-Stage Cluster 

What is the sampling weight for  unit $j$ from cluster $i$ under a one-stage cluster design?

---

## Estimation plan:  Two-Stage Cluster 

- **One option!** Use an **unbiased** Horvitz-Thompson estimator to estimate the (overall) **population total**

$$\hat{t}_{HT} = \sum_{\textrm{sampled units}} w_{ij} y_{ij}$$



---


## Population Total: Two-Stage Cluster 

- **Parameter**: $t = \sum_{i=1}^N \sum_{j=1}^{M_i} y_{ij}=  \sum_{i=1}^N t_i$

- **Unbiased Estimator:** 
$$\hat{t}_{unb} =  \sum_{i =1}^{n}  \dfrac{N}{n} M_{i} \bar{y}_{i} = \sum_{i =1}^{n} \dfrac{N}{n} \hat{t}_{i}$$
where $\hat{t}_i$ is the *estimated * total response in cluster $i$.

- **Standard error:**
$$SE(\hat{t}_{unb}) =  \sqrt{N^{2}\left(1- \dfrac{n}{N} \right) \dfrac{s^{2}_{t}}{n} + \dfrac{N}{n} \sum_{i=1}^n  \left(1- \dfrac{m_{i}}{M_{i}} \right) M_{i}^{2}\dfrac{s^{2}_{i}}{m_{i}} }$$
where $s_t$ is the sample standard deviation of *estimated* cluster totals and $s_i$ is the sample SD within cluster $i$.

---


## Population Mean: Two-Stage Cluster 


- **Parameter**: $\bar{y}_{\mathcal{U}} = \dfrac{t}{M_0}$

- **Assume that $M_0$ is known**

- **Unbiased Estimator:**
$$\hat{\bar{y}}_{unb} = \dfrac{\hat{t}_{unb} }{M_{0}}$$

- **Standard error:**
$$SE(\hat{\bar{y}}_{unb}) = \dfrac{SE(\hat{t}_{unb})}{M_{0}}$$


---


## Population Proportion: Two-Stage Cluster 


- **Parameter**: $p = \dfrac{t}{M_0}$

- Use formulas for mean where 

  - $\bar{y}_{i} = \hat{p}_{i}$ is cluster sample proportion

  - $\hat{t}_{i}$ estimates the number of observation units in cluster $i$ that are a "success"
  
  - $s^{2}_{i}= \dfrac{m_{i}}{m_{i}-1}\hat{p}_{i}(1-\hat{p}_{i})$



---

## Example: California API scores


```{r, include = FALSE}
schools <- read.csv("http://math.carleton.edu/kstclair/data/california_cluster.csv")
```

Estimate the number of schools that have over 50% of students who are eligible for a subsidized meal. 
```{r}
schools$meals_level <- ifelse(schools$meals > 50, "above 50%", "50% or below")
glimpse(schools)
```


---

## Example: California API scores

```{r}
schools_by_district <- schools %>% 
  group_by(dnum) %>%  # group by cluster (district number)
  summarize(p_hat = mean(meals_level == "above 50%"), 
            m_i = n(), # sample size per cluster
            M_i = first(district_size), # pop size per cluster
            t_hat_i = M_i*p_hat) %>%
  arrange(desc(M_i))   # arrange by big to small clusters
kable(schools_by_district, digits = 2)
```


---

## Example: California API scores

Estimate the number of schools that have over 50% of students who are eligible for a subsidized meal. 

```{r}
N <- 757  # number of clusters in pop
n <- 40   # number of clusters sampled
schools_by_district %>%
  summarize(t_unb = (N/n)*sum(t_hat_i))
```

---

## Example: California API scores

But, we should be using the `survey` package instead:

```{r}
schools$N <- 757  # N
schools$n <- 40   # n 
schools <- schools %>%
    group_by(dnum) %>% # group by cluster (district number)
    mutate(m_i = n())  #  m_i = sample size per cluster
summary(schools$m_i)
schools$wts <- (757/40)*schools$district_size/schools$m_i
summary(schools$wts)
```


---

## Example: California API scores

But, we should be using the `survey` package instead:

```{r}
schools_design <- svydesign(id= ~dnum + snum, 
                            fpc= ~N + district_size, 
                            weights = ~wts, 
                            data=schools)
svytotal(~meals_level, schools_design, deff = TRUE)
```


---

## Population Mean: Two-Stage Cluster 


- **Parameter**: $\bar{y}_{\mathcal{U}} = \dfrac{t}{M_0}$

- **What if $M_0$ is unknown!**


---


## Population Mean: Two-Stage Cluster 


- **Parameter**: $\bar{y}_{\mathcal{U}} = \dfrac{t}{M_0}$

- **Assume that $M_0$ is unknown**

- **Biased Ratio Estimator:**
$$\hat{\bar{y}} _{r} = \dfrac{ \sum_{i=1}^n \hat{t}_{i} }{ \sum_{i=1}^n M_{i} } = \dfrac{ \sum_{i =1}^n M_{i} \bar{y}_{i} }{ \sum_{i =1}^n M_{i} }$$

- **Standard error:** for large $n$:

$$SE(\hat{\bar{y}}_{r}) \approx \sqrt{\left( 1- \dfrac{n}{N}\right)  \dfrac{\sum_{i=1}^n (M_{i}\bar{y}_{i} - \hat{\bar{y}}_{r} M_{i})^{2}}{n \bar{M}^{2}(n-1)} + \dfrac{1}{nN\bar{M}^{2}} \sum_{i =1}^n  \left(1- \dfrac{m_{i}}{M_{i}} \right) M_{i}^{2}\dfrac{s^{2}_{i}}{m_{i}} }$$


---


## Population Total: Two-Stage Cluster 


- **Parameter**: $t = M_0\bar{y}_{\mathcal{U}}$

- **Assume that $M_0$ is known!!**

- **Biased Ratio Estimator:**
$$\hat{t} _{r} = M_0\hat{\bar{y}} _{r}$$

- **Standard error:** for large $n$
$$SE(\hat{t}_{r}) \approx M_0 SE(\hat{\bar{y}}_{r})$$

---

## Example: California API scores

Estimate the *proportion* of schools that have over 50% of students who are eligible for a subsidized meal. 


---

## Example: California API scores

```{r}
kable(schools_by_district, digits = 2)
```

---

## Example: California API scores

Estimate the *proportion* of schools that have over 50% of students who are eligible for a subsidized meal. 

```{r}
N <- 757  # number of clusters in pop
n <- 40   # number of clusters sampled
schools_by_district %>%
  summarize(p_hat_r = sum(t_hat_i)/sum(M_i))
```


---

## Example: California API scores

But, we should be using the `survey` package instead:

```{r}
svymean(~meals_level, schools_design, deff = TRUE)
```