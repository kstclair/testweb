---
title: "Comparing One-stage cluster sampling to SRS"
author: "Stat 260, St. Clair"
subtitle: "Week 6 (5.2)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(collapse=TRUE, prompt=TRUE, comment=NULL, message = FALSE, warning = FALSE, fig.height = 7, fig.width = 11)
library(dplyr)
library(survey)
algebra <- read.csv("http://math.carleton.edu/kstclair/data/algebra.csv")
algebra$N <- 187  # number of clusters in pop.
algebra$n <- n_distinct(algebra$class)   # n
algebra$wts <- algebra$N/algebra$n   # weights N/n
alg_design<- svydesign(id = ~class, 
                       fpc= ~N, 
                       weights= ~wts, 
                       data=algebra)

```


## When is a one-stage cluster sample more precise than SRS?

When does
$$SE(\hat{t}_{cluster}) \overset{???}{<} SE(\hat{t}_{SRS})$$
<br>
<br>

**answer:** It depends on the measurement's  **Analysis of Variance** (ANOVA)

---

##  Lohr Examples 5.6: design effect

```{r, fig.height=4, fig.width=9}
svymean(~score, alg_design, deff = TRUE)  
boxplot(score ~ class, data = algebra)
```




---

## Population ANOVA

Let $y_{ij}$ be your measurement of unit $j$ in cluster $i$

ANOVA breaks the **total** sum of squares of $y$ into **between cluster** and **within cluster** variation:
$$
SST = SSB + SSW
$$

<br>
<br>

For now, **assume that cluster sizes are equal**
$$
M_i = M \textrm{ for all clusters }i = 1, \dotsc, N
$$

---

## Population ANOVA


Source  |  df  |  Sum of Squares  |  Mean Square
------- | -------- | ---------------  | ------------
**Between**   |  $N-1$  |  $SSB= \sum_{i=1}^{N} M(\bar{y}_{i \mathcal{U}} - \bar{y}_{\mathcal{U}})^{2}$  |  $MSB=\dfrac{SSB}{N-1}$ 
**Within**   |  $N(M-1)$  |  $SSW= \sum_{i=1}^{N} (M-1) S^2_i$  | $MSW=\dfrac{SSW}{N(M-1)}$
**total**  |  $NM-1$  |  $SSTot= \sum_{i=1}^{N} \sum_{j=1}^{M} (y_{ij} - \bar{y}_{\mathcal{U}})^{2}$  |  $S^{2}= \dfrac{SSTot}{NM-1}$

---

## Variance: SRS

**Equal cluster sizes:** We've sampled $nM$ **observation units** (SSU) out of $M_0 = NM$ possible units. 

For a SRS of $nM$ **observation units**, we can write the variance, $SE^2$,  of $\hat{t}_{SRS}$ as
$$Var(\hat{t}_{SRS}) = (NM)^2\left( 1 - \dfrac{nM}{NM}\right) \dfrac{S^2}{nM}$$
where $S$ is the SD of the measurements in the population. 


---

## Variance: One-stage cluster sample

**Equal cluster sizes:** Under this assumption the variance of $\hat{t}_{unb}$ is equal to 
$$
Var(\hat{t}_{unb}) = N^2\left( 1 - \dfrac{n}{N}\right) \dfrac{M \times MSB}{n}
$$


---

## Variance: SRS vs. Stratified sample

**Equal cluster sizes:** Under this assumption, the design effect for a one-stage cluster sample total estimate is
$$DEff(\hat{\bar{y}}_{unb}) = DEff(\hat{t}_{unb}) = \dfrac{Var(\hat{t}_{unb})}{Var(\hat{t}_{SRS})} = \dfrac{MSB}{S^2}$$


---

## Variance: SRS vs. Stratified sample

Cluster sampling is more precise than an equal sized SRS when $$MSB < S^2$$

$$\Rightarrow \textrm{ between cluster variation is small}$$

$$\Rightarrow \textrm{ measurements are heterogenous within clusters}$$



---

## Measuring homogeneity within clusters

- **Intraclass correlation coefficient:** for equal sized clusters
$$ICC = 1- \dfrac{M}{M-1} \dfrac{SSW}{SSTot}  \ \ \ \textrm{ where } -\dfrac{1}{M-1} \leq ICC \leq 1$$

<br>
<br>

- **Adjusted R-squared:** can be used for unequal cluster sizes
$$R^{2}_{a} = 1-\dfrac{MSW}{S^{2}} \ \ \ \textrm{ where } 1-\dfrac{NM-1}{N(M-1)} \leq R^{2}_{a} \leq 1$$

- **For both:** 

  - values near 1 indicate **homogeneous** (similar) responses **within** clusters
  - values near 0 indicate **heterogeneous** (dissimilar) responses **within** clusters
  
  
  
---

## Design effect revisted

**Equal cluster sizes:** Under this assumption the variance of $\hat{t}_{unb}$ is equal to 
\begin{align*}
DEff(\hat{t}_{unb}) & =  \dfrac{MSB}{S^2} \\ 
& = \dfrac{MN-1}{M(N-1)}\left( 1 + (M-1)ICC \right) \\
& = 1 + \dfrac{N(M-1)}{N-1}R^2_a
\end{align*}


---

## Design effect revisted

What is the design effect if 

- $N$ is big
- $M = 11$
- $R^2_a = 0.5$

---

## Big picture

- One-stage cluster sampling is "good" for precision if SSU within clusters have  very **heterogeneous** responses

  - true whether or not cluster sizes are equal

- But often SSU within clusters have very **homogeneous** responses

  - clusters contain "similar" observation units

  - clusters defined for **cost-saving** reasons, not for precision


---

## Post-Hoc comparison


Q: How do we compute the design effect with a **sample of data** from any one-stage cluster sample? 

**1. (Any cluster sizes)** Use sampling weights to estimate $Var(\hat{t}_{srs})$

- This is what the `survey` package when you use `deff=TRUE`


---

## Post-Hoc comparison

Q: How do we compute the design effect with a **sample of data** from any one-stage cluster sample? 

**2. Equal cluster sizes:** Estimate population sum of square values from **sample** mean square values $msw$ and $msb$:
$$\widehat{SSW} = N(M-1)msw \ \ \ \ \ \widehat{SSB} = (N-1)msb$$ 

The estimated design effect is
\begin{align*}
\widehat{DEff}(\hat{t}_{unb}) & =  \dfrac{\widehat{MSB}}{\hat{S}^2}  = \dfrac{msb}{(\widehat{SSW}  + \widehat{SSB})/(NM-1)}
\end{align*}



---

## Estimating $ICC$ and $R^2_a$

$$\widehat{SSW} = N(M-1)msw, \ \ \ \ \ \widehat{SSB} = (N-1)msb, \ \ \ \ \ \widehat{SST} = \widehat{SSB} + \widehat{SSW}$$ 

- Estimated $ICC$ is
$$ICC = 1- \dfrac{M}{M-1} \dfrac{\widehat{SSW} }{\widehat{SST}}$$

- Estimated $R^2_a$ is
$$\hat{R}^{2}_{a} = 1-\dfrac{msw}{\hat{S}^2}$$

---


## Example - GPA

$N = 100$, $n = 5$, $M_i = 4$, $M_0  = 400$


  |  Suite 1  |  Suite 2  |  Suite 3  |  Suite 4  |  Suite 5 
----- | ------ | ------- | ----- | ----- | ---- 
1  |  3.08  |  2.36  |  2.00  |  3.00  |  2.68 
2  |  2.60  |  3.04  |  2.56  |  2.88  |  1.92 
3  |  3.44  |  3.28  |  2.52  |  3.44  |  3.28 
4  |  3.04  |  2.68  |  1.88  |  3.64  |  3.20 
total  |  12.16  |  11.36  |  8.96  |  12.96  |  11.08 



```{r}
dorm <- read.csv("http://math.carleton.edu/kstclair/data/Dorm_Cluster.csv")
dplyr::glimpse(dorm)
```

---

## Example - GPA

$N = 100$, $n = 5$, $M_i = 4$, $M_0  = 400$


What is the design effect, ICC and $R^2_a$ for estimating mean GPA?

```{r}
dorm_lm <- lm(gpa ~ factor(room), data = dorm)
anova(dorm_lm)
```

---



---

##  Lohr Examples 5.6: design effect of 2.245

What if cluster sizes are not equal? 
```{r}
alg_lm <- lm(score ~ factor(class), data = algebra)
anova(alg_lm)
msb <- 644.14 
msw <- 304.08 
msb/var(algebra$score)   # rough DEff guess
```

---

##  Lohr Examples 5.6: design effect of 2.245

What if cluster sizes are not equal? 
```{r}
summary(alg_lm)$adj.r.squared  # rough R^2_a guess
library(dplyr)
algebra %>%
  group_by(class) %>%
  summarize(Mi = n()) %>%  # gets Mi values by class
  summarize(mean(Mi))      # mean Mi per class
1 +  187*(25-1)*.04/(187-1)  # rough DeFF guess based on R^2_a
```

