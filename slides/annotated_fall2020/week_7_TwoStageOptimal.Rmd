---
title: "Optimal sample size allocation for cluster sampling"
author: "Stat 260, St. Clair"
subtitle: "Week 7 (5.4)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r, include=FALSE}
knitr::opts_chunk$set(collapse=TRUE, prompt=TRUE, comment=NULL,tidy.opts=list(width.cutoff=60),tidy=FALSE,eval=TRUE,eval=TRUE, warning=FALSE, message  = FALSE, fig.width = 11, fig.height = 7)
library(dplyr)
library(tidyr)
library(ggplot2)
```


## Determining sample sizes for a cluster sample

**Problem:** You have a quantitative variable $y$ and you want to estimate its population mean/total.

<br>

**Question 1:** How many SSU (elements) to sample?

**Question 2:** How many PSU (clusters) to sample?

**Optional:** How to do this in an optimal way? 

---

## Optimal Allocation

This allocation is **optimal** because it either

- **minimizes costs** for a fixed SE/margin of error, *or* 

- **minimizes SE/margin of error**  for a fixed survey cost.


- An optimal solution is "easy" to derive assuming equal cluster sizes:

    - $M_i = M$: cluster sizes are equal
    
    - $m_i = m$: cluster sample sizes are equal 

---

## Optimal Allocation


**Mathematical Problem:** 

- Let $c_{1}$ be the cost per PSU (cluster) and $c_{2}$ be the cost per SSU (element).  With $c_0$ fixed costs, the total survey costs are
$$C(m, n) = c_0 + c_1n + c_2(mn)$$

<br>
<br>

- Variance is also a function of $m$ and $n$ and ANOVA MS. 
$$V(\hat{\bar{y}}_{unb}; m, n) = \left( 1- \dfrac{n}{N}\right) \dfrac{MSB}{nM} + \left( 1- \dfrac{m}{M}\right) \dfrac{MSW}{nm}$$


---

## Optimal Allocation: 1. SSU sample size

**Solution:** Use Lagrange Multiplier method to minimize one function  (C or V) subject to the contraints of the other function.

- The optimal SSU (element) sample size is
$$m_{opt} = \sqrt{\dfrac{c_1M(N-1)(1-R^2_a)}{c_2 (NM-1)R^2_a} } \approx \sqrt{\dfrac{c_1(1-R^2_a)}{c_2 R^2_a} } \ \ \textrm{when } N > > M$$
where $R^2_a = 1- \dfrac{MSW}{S^2}$ 


---
## Optimal Allocation

- We know $m_{opt}$

- final sample size is then determined by $n$:

$$n \times m_{opt} = \textrm{number of observation units sampled}$$

<br>

**Question 2:** Determine $n$ subject to a constraint:

-  fixed SE/margin of error, *or* 

-  fixed survey cost.


---


## Optimal Allocation: 2. PSU sample size: 
### (a) achieving a margin of error


**Problem:** How many PSU to sample to estimate $\bar{y}_{\mathcal{U}}$ with $(1-\alpha)100\%$ confidence and a margin of error $e = z_{\alpha/2} SE(\hat{\bar{y}}_{unb})$?

**Solution:** Get $m_{opt}$, if you ignore the FPC then
$$n_{opt} = \dfrac{ \nu z^{2}_{\alpha/2}}{e^{2}} \ \ \textrm{  where  }  \ \ \nu =  \dfrac{MSB}{M} + \left( 1- \dfrac{m_{opt}}{M}\right) \dfrac{MSW}{m_{opt}}$$

- If $N$ is smaller, don't ignore FPC and use:
$$n_{opt} =  \dfrac{ \nu z^{2}_{\alpha/2}}{e^{2} +\dfrac{ z^2MSB}{NM}}$$

- To estimate $t$ with $e_{t}$ margin of error,  set $e=e_{t}/(NM)$.



---

## Optimal Allocation: 2. PSU sample size: 
### (b) Do not go over budget

**Problem:** How many PSU to sample if your budget is $C$ dollars (or man hours, etc...)?

**Solution:** Get  $m_{opt}$, then
$$n_{opt} = \dfrac{C - c_{0}}{c_1 + c_2m_{opt}}$$

---

## Optimal Allocation

- Note: The **cost** and **ME** solutions for $n$ work for *any* values of $m$ given a desired cost or ME. 


- You need a guess at MSB and MSW

    -  $MSB = S^2_t/M$
      - $S_{t}$: how to cluster totals vary?
    
    - $MSW = \sum_{i}^{N} S^2_i/N$
      - $S_i$: within cluster variation?
    


---

## Example: Dorms

- New GPA study: want to estimate average dorm GPA with a 95% ME of 0.2
    - $N=100$ rooms with $M=4$ students per room
    
- Previous study:  [One-stage example](https://kstclair.github.io/stat-260/slides/week_6_OneStagevsSRS.pdf)

    - $msw = 0.18504$, $msb = 0.56392$ and $\hat{S}^2 = 0.279$
    
    - $\hat{R}^2_a \approx 0.337$

<br>
- Costs?  

  - $c_1 = 20$ minutes to travel between rooms and 
  
  - $c_2 = 10$ minute to talk to each student. 
  


---

## Example: Dorms

What is the optimal number of student to sample per room?


---

## Example: Dorms

How many rooms to sample to get a ME of $e=0.2$ for estimating mean GPA?




---

## Example: Dorms - check answer

- We used $z=1.96$ for 95% confidence, but we should be using a t-distribution with $n-1$ degrees of freedom for CI when $n$ is "small"

- Check margin of error with our larger multiplier, suggests a larger $n$
```{r}
n <- 16
qt(.975, df= n-1)
se_squared <- (1-n/100)*0.56392/(n*4) + (1-2/4)*0.18504/(n*2)  
qt(.975, df= n-1)*sqrt(se_squared) # 0.2 or less??
```


---

## Example: Dorms - check answer

- Try $n$ of 17, 18 and 19!
```{r}
n <- c(17,18,19)
se_squared <- (1-n/100)*0.56392/(n*4) + (1-2/4)*0.18504/(n*2)  
qt(.975, df= n-1)*sqrt(se_squared) # 0.2 or less??
```

- Final answer: $n=19$ will give a ME of at most 0.2

---

## Example: Dorms

How many rooms to sample if we have a fixed cost of 300 minutes?



---

## Example: Dorms 



```{r, echo = FALSE}
m_opt <- function(c1, c2, R2_a, N, M) 
{ sqrt(c1*M*(N-1)*(1-R2_a)/(c2*(N*M-1)*R2_a))}

n_opt <- function(C, c1, c2, m_opt)
{ C/(c1 + c2*m_opt)}

se <- function(n, m, N, M, MSW, MSB)
{ sqrt((1-n/N)*MSB/(n*M) + (1-m/M)*MSW/(n*m))}

mydata <- tibble(
  cost = c("c1=40, c2=5", "c1=10, c2=20", "c1=20, c2=10"),
  c1 = c(40, 10, 20),
  c2 = c(5, 20, 10), 
  x = c(1,2,3))

mydata_grid <- expand(mydata, nesting(cost, c1, c2), m = seq(.2, 5, by=.1))

mydata_grid <- mydata_grid %>%
  mutate(
    n = n_opt(300, c1, c2, m), 
    se = se(n, m, 100, 4, 0.18504, 0.56392)
  )


mydata <- mydata %>%
  mutate(
    m = m_opt(c1, c2, 0.337, 100, 4), 
    n = n_opt(300, c1, c2, m), 
    se = se(n, m, 100, 4, 0.18504, 0.56392)
  )

ggplot(mydata_grid, aes(x = m, y = se, color = cost)) + 
  geom_line(aes(linetype = cost)) + 
  geom_point(data = mydata, aes(x=m, y = se, color = cost)) +
  labs(title="SE as a function of m for cost of 300 minutes and R^2_a = 0.334") + 
  theme_minimal() + 
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"), 
        legend.text = element_text(size=16),
        legend.title = element_text(size=16),
        plot.title = element_text(size=16)) 


```



---

## Example: Dorms with $R^2_a = 0.7$



```{r, echo = FALSE}

mydata <- tibble(
  cost = c("c1=40, c2=5", "c1=10, c2=20", "c1=20, c2=10"),
  c1 = c(40, 10, 20),
  c2 = c(5, 20, 10), 
  x = c(1,2,3))

mydata_grid <- expand(mydata, nesting(cost, c1, c2), m = seq(.2, 5, by=.1))

s2 <- 0.18504/(1-.334)

mydata_grid <- mydata_grid %>%
  mutate(
    n = n_opt(300, c1, c2, m), 
    se = se(n, m, 100, 4, s2*(1-.7), s2*(100*(4-1)*.7/(100-1) + 1))
  )


mydata <- mydata %>%
  mutate(
    m = m_opt(c1, c2, .7, 100, 4), 
    n = n_opt(300, c1, c2, m), 
    se = se(n, m, 100, 4, s2*(1-.7), s2*(100*(4-1)*.7/(100-1) + 1))
  )

ggplot(mydata_grid, aes(x = m, y = se, color = cost)) + 
  geom_line(aes(linetype = cost)) + 
  geom_point(data = mydata, aes(x=m, y = se, color = cost)) +
  labs(title="SE as a function of m for cost of 300 minutes and R^2_a = 0.7") + 
  theme_minimal() + 
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"), 
        legend.text = element_text(size=16),
        legend.title = element_text(size=16),
        plot.title = element_text(size=16)) 


```




---
## Optimal Allocation: Unequal cluster sizes


- If clusters are **not too variable**, the (almost) optimal solution could use $\bar{M}$ to get $m_{opt}$
    
  - use $m_{opt}$ for all clusters or 
    
  - use an average of $m_{opt}$ 
    
<br>

- If clusters sizes are variable, don't use the optimal solution for equal sizes!
