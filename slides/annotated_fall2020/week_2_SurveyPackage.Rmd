---
title: "Intro to the `survey` package"
author: "Stat 260, St. Clair"
subtitle: "Week 2"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(collapse=TRUE, prompt=TRUE, comment=NULL, message = FALSE, warning = FALSE)
```

## `survey` package

- use to analyze survey data by defining the sampling design

- **use for all estimation problems that involve a data set!**

  - don't do a "by hand" calculation when you can use `survey`
  
---

## Basic elements

1. Define a **design object**

2. Estimate mean/total/proportion using the design object

3. (more) can also graph and model using a design's sampling weights

---

## Design object

```{r eval = FALSE}
library(survey)
my_design <- svydesign(id, fpc, weights, mydata)
```

- `id` defines the sampling units

- `fpc` gives $N$ or $n/N$ for fpc correction

- `weights` sampling weights, not needed if self-weighting (all weights equal)

---

## Estimation

Estimates/SE:
```{r, eval = FALSE}
svytotal(~vars, my_design)  # pop total estimate
svymean(~vars, my_design)   # pop mean estimate
```

Confidence interval:
```{r, eval=FALSE}
mean_obj <- svymean(~vars, my_design)   # pop mean estimate
confint(mean_obj)  # CI using N(0,1)
confint(mean_obj, df = degf(my_design))  # CI using t
```

---

## Lohr Examples 2.5 and 2.10

The file  `agsrs.csv` contains farm data collected from a SRS of $n=300$  counties from $N=3078$ in the US. 

```{r}
library(SDaA)   # data package for the textbook
str(agsrs)   
```

---

## Design

We need to add population size and sampling weights to the data frame:

```{r}
agsrs$N <- 3078  # population size
nrow(agsrs)   # sample size
agsrs$wts <- agsrs$N/nrow(agsrs)  # sampling weights for SRS (N/n)
head(agsrs$wts)
```

---
## Design

```{r}
library(survey)
design_srs <- svydesign(id= ~1, fpc= ~N, weights= ~wts, data= agsrs)
summary(design_srs)
```





---

## Lohr Examples 2.5 and 2.10

The variable `acres92` and `acres87` record the number of farming acres in a county in 1992 and 1987, respectively.

```{r}
# SRS estimate/SE of total farm acres
svytotal(~acres92 + acres87, design_srs)  
```

```{r}
mean_obj <- svymean(~acres92, design_srs)
confint(mean_obj, df = degf(design_srs))
```


---

## Lohr Examples 2.5 and 2.10

What proportion of counties in the US have fewer than 200,000 farming acres?

```{r}
agsrs$lt200k92<- ifelse(agsrs$acres92 < 200000, 
                        "less than 200k", "greater than 200k") 
table(agsrs$lt200k92)
```

```{r}
design_srs <- update(design_srs, lt200k92 = agsrs$lt200k92)
svymean(~lt200k92, design_srs) 
```



