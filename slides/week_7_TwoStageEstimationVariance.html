<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Two-stage cluster sampling estimation: variance</title>
    <meta charset="utf-8" />
    <meta name="author" content="Stat 260, St. Clair" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Two-stage cluster sampling estimation: variance
## Week 7 (5.3)
### Stat 260, St. Clair

---







## Population Total: Two-Stage Cluster 

- **Parameter**: `\(t = \sum_{i=1}^N \sum_{j=1}^{M_i} y_{ij}=  \sum_{i=1}^N t_i\)`

- **Unbiased Estimator:** 
`$$\hat{t}_{unb} =  \sum_{i =1}^{n}  \dfrac{N}{n} M_{i} \bar{y}_{i} = \sum_{i =1}^{n} \dfrac{N}{n} \hat{t}_{i}$$`

- **Standard error:**
`$$SE(\hat{t}_{unb}) =  \sqrt{N^{2}\left(1- \dfrac{n}{N} \right) \dfrac{s^{2}_{t}}{n} + \dfrac{N}{n} \sum_{i=1}^n  \left(1- \dfrac{m_{i}}{M_{i}} \right) M_{i}^{2}\dfrac{s^{2}_{i}}{m_{i}} }$$`

---

## Variance: between + within cluster variation

**1. Between cluster variation:** `\(N^{2}\left(1- \dfrac{n}{N} \right) \dfrac{s^{2}_{t}}{n}\)`

  - just the **one-stage** variance 

&lt;br&gt;
&lt;br&gt;
&lt;br&gt;

**2. Within cluster variation:**  `\(\dfrac{N}{n} \sum_{i=1}^n  \left(1- \dfrac{m_{i}}{M_{i}} \right) M_{i}^{2}\dfrac{s^{2}_{i}}{m_{i}}\)`

  - added because we don't sample *all* units within a cluster

&lt;br&gt;
&lt;br&gt;

- Same explanation of the *ratio* estimator `\(SE(\hat{\bar{y}}_r)\)`

---

## Comparing cluster sampling and SRS

- **One-stage** *less* precise than a SRS when clusters are *homogeneous*

  - Same holds true for **two-stage**
  
  - Generally, `\(SE_{two-stage} \geq  SE_{one-stage} &gt; SE_{SRS}\)`

---

## Two-stage cluster sampling: Assessing homogeneity

- Visually: plot cluster id vs `\(y_{ij}\)` (boxplot, scatterplot)

- Adjusted R-squared: 
$$
\hat{R}^{2}_{a} = 1-\dfrac{\widehat{MSW}}{\hat{S}^{2}}
$$
- `\(MSW\)` is estimated from **sample ANOVA** values  `\(msw\)`

- **Cluster/sample sizes equal:**  `\(S^2\)` is estimated from **sample ANOVA** values `\(msb\)` and `\(msw\)`:
$$
\hat{S}^2 = \dfrac{\dfrac{M}{m}(N-1)msb + \left(\dfrac{m-1}{m}NM + \dfrac{M}{m}-1\right)msw}{NM-1} 
$$

- **Cluster/sample sizes NOT equal:** best "by hand" (but biased) approximation is the sample variance of all responses `\(s^2\)`


---

## Example: California API scores by district


```r
&gt; schools_by_district &lt;- schools %&gt;% 
+   group_by(dnum) %&gt;%  # group by cluster (district number)
+   summarize( s_i = sd(api00),    # SD by cluster
+             m_i = n(), # sample size per cluster
+             M_i = first(district_size) ,
+             samp_frac = m_i/M_i)
&gt; summary(schools_by_district)
      dnum            s_i               m_i            M_i        
 Min.   : 15.0   Min.   :  8.485   Min.   :1.00   Min.   : 1.000  
 1st Qu.:221.0   1st Qu.: 20.769   1st Qu.:1.75   1st Qu.: 1.750  
 Median :541.5   Median : 34.894   Median :3.00   Median : 3.000  
 Mean   :463.7   Mean   : 39.464   Mean   :3.15   Mean   : 6.775  
 3rd Qu.:675.2   3rd Qu.: 47.753   3rd Qu.:5.00   3rd Qu.: 5.000  
 Max.   :795.0   Max.   :127.982   Max.   :5.00   Max.   :72.000  
                 NA's   :10                                       
   samp_frac      
 Min.   :0.06944  
 1st Qu.:1.00000  
 Median :1.00000  
 Mean   :0.87540  
 3rd Qu.:1.00000  
 Max.   :1.00000  
                  
```


---

## Example: California API scores by district


```r
&gt; ggplot(schools, aes(x=dname, y = api00)) + 
+   geom_point() + 
+   geom_vline(aes(xintercept=dname), linetype= "dotted") + 
+   coord_flip() + 
+   labs(x="District (cluster)")
```

![](week_7_TwoStageEstimationVariance_files/figure-html/unnamed-chunk-3-1.png)&lt;!-- --&gt;



---

## Example: California API scores by district

- Cluster (district) sizes in the population are *not* similar. 

  - quick approximation gives `\(R^2_a  \approx 0.86\)`


```r
&gt; api_lm &lt;- lm(api00 ~ dname, data=schools)
&gt; anova(api_lm)
Analysis of Variance Table

Response: api00
          Df  Sum Sq Mean Sq F value    Pr(&gt;F)    
dname     39 2028811   52021  20.267 &lt; 2.2e-16 ***
Residuals 86  220740    2567                      
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
&gt; 1 - 2567/var(schools$api00)   # r^2_a =  1=msw/s^2
[1] 0.8573605
&gt; summary(api_lm)$adj.r.squared  # r^2_a 
[1] 0.8573744
```


---

## Example: California growth by district


```r
&gt; ggplot(schools, aes(x=dname, y = growth)) + 
+   geom_point() + 
+   geom_vline(aes(xintercept=dname), linetype= "dotted") + 
+   coord_flip() + 
+   labs(x="District (cluster)")
```

![](week_7_TwoStageEstimationVariance_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;


---

## Example: California growth by district

- quick approximation gives `\(R^2_a  \approx 0.24\)`



```r
&gt; growth_lm &lt;- lm(growth ~ dname, data=schools)
&gt; summary(growth_lm)$adj.r.squared
[1] 0.2448077
```


---

## Example: California growth by district

- `growth` is more heterogeneous by district so its SE is more similar to a SRS than `api00`


```r
&gt; # design from estimation slides
&gt; svymean(~api00 + growth, schools_design, deff = TRUE)
          mean      SE   DEff
api00  670.812  30.099 6.2505
growth  25.778   2.842 1.5794
```

---

## Variance: between + within cluster variation

`$$Var(\hat{t}_{unb}) =  N^{2}\left(1- \dfrac{n}{N} \right) \dfrac{S^{2}_{t}}{n} + \dfrac{N}{n} \sum_{i=1}^N  \left(1- \dfrac{m_{i}}{M_{i}} \right) M_{i}^{2}\dfrac{S^{2}_{i}}{m_{i}}$$`
&lt;br&gt;

**Sketch of Proof**
Uses Appendix Section A.4 Rule 5:
$$
Var(Y) = Var_y(E_x(Y \mid X)) + E_y(Var_x(Y \mid X))
$$



---

## A. between  cluster variation

Fixed clusters (stage 1): `\(i \in \mathcal{S}\)` are fixed
`$$E_2(\hat{t} \mid \textrm{stage 1 fixed})$$`



---

## A. between  cluster variation

How does `\(E_2\)` vary across stage 1 samples?
`$$Var_1(E_2(\hat{t} \mid \textrm{stage 1 fixed}))$$`



---

## B. within  cluster variation

Fixed clusters (stage 1): `\(i \in \mathcal{S}\)` are fixed
`$$Var_2(\hat{t} \mid \textrm{stage 1 fixed})$$`



---

## B. within  cluster variation

What is the expected `\(V_2\)` across stage 1 samples?
`$$E_1(Var_2(\hat{t} \mid \textrm{stage 1 fixed}))$$`
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
