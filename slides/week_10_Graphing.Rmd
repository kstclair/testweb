---
title: "Graphing complex survey data"
author: "Stat 260, St. Clair"
subtitle: "Week 10 (ch 7)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(collapse=TRUE,
                      message = FALSE, warning = FALSE, 
                      fig.height = 7, fig.width = 11, 
                      fig.align = 'center')
library(survey)
library(SDAResources)
library(tidyverse)
```




### Goal:


Use survey data to create a visualization that represents the population.

- Self-weighting samples: (SRS)
    - Just use basic EDA tools: histogram, boxplot, scatterplots, bar graphs

--

- Stratified samples: self-weighting within strata
    - Basic EDA within each strata: side-by-side boxplots, faceted histograms/scatterplots, grouped bar graphs

--

- Clustered samples: self-weighting within clusters
    - Basic EDA within each cluster: side-by-side boxplots, faceted histograms/scatterplots, grouped bar graphs

--

- But what if we want to visualize the distribution of a variable for the entire population, not just one strata/cluster?

- What if we have a more complex sampling design?


---

### Two-stage cluster: California API scores


- (week 7) Recall the two-stage cluster sample of schools in CA
    - Cluster = district
    - Elements = schools
    - Unequal cluster and sample sizes so sampling weights vary across clusters

- Goal: understand API scores in 2000 (api00)



```{r, include = FALSE}
schools <- read.csv("http://math.carleton.edu/kstclair/data/california_cluster.csv")
schools$N <- 757  # N
schools$n <- 40   # n 
schools <- schools %>%
    group_by(dnum) %>% # group by cluster (district number)
    mutate(m_i = n())  #  m_i = sample size per cluster
schools$wts <- (757/40)*schools$district_size/schools$m_i
```

```{r}
schools_design <- svydesign(id= ~dnum + snum, 
                            fpc= ~N + district_size, 
                            weights = ~wts, 
                            data=schools)
```

---

### API scores within districts: 


Represents `API00` scores within districts and variation between districts in the population




```{r, echo=FALSE}
data(api) # built-in dataset from survey package
boxplot(api00 ~ dnum, data=schools, xlab="district (cluster)", ylab="API 2000")
title("api00 within each Cluster")
```

---

### API scores in all of CA:

.large[
- What if we want a boxplot that represents API00 scores for all schools in CA, not just the schools in our sample?
    - Create the usual survey design object and use `svyboxplot`
]

--

.large[
```{r, fig.height=5}
svyboxplot(api00~1, schools_design, 
           horizontal=TRUE, xlab="api00 score")
```
]

---


### API scores in all of CA:

.large[
Why does the unweighted (raw) data misrepresent API00 scores across CA?
]

```{r,fig.height=6.5, echo=FALSE}
data(api)
boxplot(apipop$api00, schools$api00, ylab="API 2000",xlim=c(.5,3.5))
svyboxplot(api00~1,schools_design,add=T,at=3, width=1)
abline(h=mean(apipop$api00), col="red")
axis(1,c(1,2,3),labels=c("population", "raw data","weighted data"))
title("Comparing api00 distributions")
```

---

### API scores in all of CA:

.large[
Answer is in the relationship between weights and response
- In the sample: schools with high score overrepresented (many schools with high scores but low sampling weights)
]

```{r, fig.height=5, echo = FALSE}
ggplot(schools, aes(x=wts, y=api00)) + geom_point() +
  geom_hline(yintercept=mean(apipop$api00), color="red") + 
  scale_x_log10() + labs(x="sampling weight",y="API 2000") 
```

---

### Agpps: PPS ag survey data

.large[
- 15 Counties selected with probability proportional to `acres87`

- Goal: estimate average `acres92`
    - Sample mean is 849,371
    - HT estimate is 405,054
    - Population mean is 308,582
]


<br>

--

.large[
- Graphically:
    - (unweighted) sample of 15 counties is adequate for EDA for the sample, looking for outliers

    - (unweighted) sample will not reflect the population distribution of acres92

    - Solution: use the sampling weights when graphing 
]

---

### Weighted Boxplots

.large[
- Usual boxplot:
    - Find 5 number summary (min,Q1,median,Q3,max)
    - ID outliers using 1.5 IQR rule
    - Plot 5 number summary and outliers
]

<br>

--
.large[
- Weighted boxplot
    - Find Q1, median, Q3 using the weighted empirical cumulative distribution function (ecdf):
$$\hat{F}(a) = P(Y \leq a) = \dfrac{\sum_{\textrm{all }i \textrm{ where } y_i \leq a} w_i}{\sum_{i \in \mathcal{S}} w_i}$$
    - The $\hat{\theta}_q$ quantile is the smallest value $a$  where $\hat{F}(a) \geq q$.
]

---


```{r, include=FALSE}
incl_mat<- as.matrix(agpps[,20:34])  # joint inclusion probs (0's on diagonal)
diag(incl_mat) <- agpps$SelectionProb
ag_pps<- svydesign(id = ~1, 
                   fpc = ~SelectionProb,   # inclusion probs
                   data = agpps,  
                   pps = ppsmat(incl_mat)) ## HT
svymean(~acres92, ag_pps)
mean(agpop$acres92, na.rm=TRUE)
mean(agpps$acres92)
```

### Weighted Boxplots

```{r}
ordered_agpps <- arrange(agpps, acres92) %>% select(acres92, SelectionProb)
ordered_agpps %>% mutate(weight = 1/SelectionProb, 
                         wt.ecdf = cumsum(weight)/sum(weight),
                         unwt.ecdf = 1:15/15)
```

---

## Weighted Boxplots



- Ignoring weights, the median `acres92` is 545,670

```{r}
quantile(agpps$acres92,c(0,.25,.5,.75,1))
```

--

- Using weights, the estimated population median `acres92` is 194,022

```{r}
svyquantile(~acres92,ag_pps, c(0,.25,.5,.75,1), ci=FALSE)
```



```{r, include = FALSE}
a <- (.5-0.446)/(.584-0.446)
a
175847 + (194022 - 175847)*a
oldsvyquantile(~acres92,ag_pps, c(0,.25,.5,.75,1))
svyquantile(~acres92,ag_pps, c(0,.25,.5,.75,1), qrule = "hf4", ci=FALSE)
```


---

### Agpps: PPS ag survey data

.large[
Counties with higher `acres92` have a higher inclusion probability: raw data favors large response values

]

```{r, echo=FALSE}
boxplot(agpps$acres92,xlim=c(.5,3.5),ylim=c(0,4000000))
svyboxplot(acres92~1, ag_pps, ylim=c(0,4000000),add=T,at=2)
boxplot(agpop$acres92,at=3,ylim=c(0,4000000),add=T)
axis(1,c(1,2,3),labels=c("unweighted","weighted","population"))
title("Acres92 distributions")
```

---

## Weighted Histograms

.large[
- Usual (density) histogram:
    - Divide data into equal width bins (b=width)
    - Count the number of data points in each bin
    - Height = (proportion of observations in bin)/b
    - Area of bar = proportion of observations
]

<br>

--

.large[
- Weighted (density) histogram
    - Height is weighted proportion in each bin:
$$\textrm{height of bin } j = \dfrac{\sum_{\textrm{all } y_i \textrm{ in bin } j} w_i}{b\sum_{i \in \mathcal{S}} w_i}$$
]

---

### Agpps: PPS ag survey data

.large[
Use `svyhist(~acres92, ag_pps)` to generated a weighted histogram

]
```{r, echo=FALSE}
par(mfrow=c(1,3))
hist(agpps$acres92,xlim=c(0,4000000),main="unweighted acres92")
points(mean(agpps$acres92),0,col="red",cex=1.5,pch="X")
svyhist(~acres92,ag_pps,xlim=c(0,4000000),main="weighted acres92")
points(342551.57,0,col="red",cex=1.5,pch="X")
hist(agpop$acres92,xlim=c(0,4000000),main="population: acres92")
points(mean(agpop$acres92),0,col="red",cex=1.5,pch="X")
```


---

### Bar plots


Use `barplot` to plot proportions obtained from `svymean`

```{r, fig.height=4}
props <- svymean(~farms92 > 500, ag_pps)
props
barplot(props, main = "proportion of counties with more or less than 500 farms")
```


---

### Stacked Bar plots

Proportion of counties with more or less than 500 farms by region (NC or not):

```{r, fig.height=2.5}
props <- svyby(~farms92 > 500, ~ region == "NC", ag_pps, svymean)
props
barplot(props, beside = FALSE)
```


---

### `ggplot2` options

We can create a weighted histogram by adding a `weight` aesthetic:

```{r, fig.height=5}
ggplot(agpps, aes(x = acres92, weight = SamplingWeight)) +
  geom_histogram(bins = 10)
```


---

### `ggplot2` options

Get proportions using `geom_bar` with `weight` equal to $w_i/\sum w_i$

```{r, fig.height=5}
ggplot(agpps, aes(x = farms92 > 500)) + 
  geom_bar(aes(weight = SamplingWeight/sum(SamplingWeight))) + 
  labs(y = "proportion")
```


---

### `ggplot2` options

Stacked bar graphs using `fill` position don't need

```{r, fig.height=5}
ggplot(agpps, aes(x = region == "NC",fill = farms92 > 500)) + 
  geom_bar(aes(weight = SamplingWeight), position = "fill")+ 
  labs(y = "proportion")
```
