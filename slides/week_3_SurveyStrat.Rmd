---
title: "`survey` package: stratified designs"
author: "Stat 260, St. Clair"
subtitle: "Week 3"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(collapse=TRUE, prompt=TRUE, comment=NULL, message = FALSE, warning = FALSE)
```


## Design object: Stratified sampling

```{r eval = FALSE}
library(survey)
my_design <- svydesign(id, fpc, weights, strata, mydata)
```

- `id` defines the sampling units

- `fpc` gives $N_h$ or $n_n/N_n$ for fpc correction

- `weights` sampling weights $N_h/n_h$

- `strata` gives the stratification variable(s)
  - if more than one variable defines strata use `strat = ~var1 + var2`


---

## Lohr Examples 3.2 and 3.6

The file  `agsrs.csv` contains farm data collected from a SRS of $n=300$  counties from $N=3078$ in the US. 

```{r}
library(SDaA)
str(agstrat)    # looks at the ``structure'' of the data frame's variables
``` 

---

## Design

We need to add **stratum** population sizes to the data frame:

```{r}
# recode maps pop sizes to the right regions
library(dplyr)
agstrat$N <- recode(agstrat$region, 
                    NC = 1054, 
                    NE = 220, 
                    S = 1382, 
                    W = 422)
# check if recoding worked:
agstrat %>% 
  group_by(region) %>% 
  summarize(min(N), max(N))
```



---

## Design

We need to add **stratum** sampling weights $N_h/n_h$ to the data frame:

```{r}
# sample sizes:
table(agstrat$region)
# recode maps sample sizes to the right regions
agstrat <- agstrat %>% 
  group_by(region) %>% 
  mutate(n = n())  %>% ungroup()
agstrat$n[1:180]
```



---

## Design

We need to add **stratum** sampling weights $N_h/n_h$ to the data frame:

```{r}
# add weights
agstrat$wts <- agstrat$N/agstrat$n
# check work:
agstrat %>% 
  group_by(region) %>% 
  summarize(min(wts), max(wts))
```


---
## Design

```{r}
library(survey)
design_strat <- svydesign(id= ~1, 
                        fpc= ~N, 
                        weights= ~wts, 
                        strata = ~region,
                        data= agstrat)
summary(design_strat)
```





---

## Lohr Examples 3.2 and 3.6

The variable `acres92`  records the number of farming acres in a county in 1992.

```{r}
# SRS estimate/SE of total farm acres
svytotal(~acres92, design_strat)  
```

```{r}
mean_obj <- svymean(~acres92, design_strat)
mean_obj
confint(mean_obj, df = degf(design_strat))
```


---

## Lohr Examples 3.2 and 3.6

What proportion of counties in the US have fewer than 200,000 farming acres?

```{r}
agstrat$lt200k92<- ifelse(agsrs$acres92 < 200000, 
                        "less than 200k", "greater than 200k") 
design_strat <- update(design_strat, lt200k92 = agstrat$lt200k92)
svymean(~lt200k92, design_strat)
```



---

## Lohr Examples 3.2 and 3.6: estimating within strata

```{r}
# estimated region means
region_mean <- svyby(~acres92, # variable
                   ~region,  # strata
                   design_strat, # design
                   svymean)  # gets mean estimates
region_mean   # SRS estimates for each region
confint(region_mean,df=degf(design_strat))
```

---

## Lohr Examples 3.2 and 3.6: stratified vs SRS

The **design effect** of a design compares it's $SE^2$ to what you'd expect from a SRS:

$$DEff = \dfrac{V(\hat{t}_{str})}{V(\hat{t}_{SRS})} \approx 0.7945$$

```{r}
# Design effect estimated from the stratified sample:
svytotal(~acres92, design_strat, deff=T) 
```

The variance for estimating total is about 20% lower under a stratified design compared to an *equal sized* SRS. 