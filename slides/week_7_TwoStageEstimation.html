<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Two-stage cluster sampling estimation</title>
    <meta charset="utf-8" />
    <meta name="author" content="Stat 260, St. Clair" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Two-stage cluster sampling estimation
## Week 7 (5.3)
### Stat 260, St. Clair

---







## Design: One-Stage Cluster  Sample 

**Defined**: We take a SRS of `\(n\)` **clusters** and survey **every observation unit** in selected clusters.


![](cluster_pic.jpg)

.footnote[https://spot.pcc.edu/~evega/section-4.html]

---


## Design: Two-Stage Cluster  Sample 


**Defined**: We take a **SRS of clusters** and take a **SRS of observation units** within each selected cluster.



![](multistage_pic.jpg)

.footnote[https://spot.pcc.edu/~evega/section-4.html]

---


## Design: Two-Stage Cluster  Sample 

- **Primary Sampling Units (PSU):** clusters
  
  - `\(N\)`: number of clusters in the population
  
  - `\(n\)`: number of clusters sampled

--

- **Secondary Sampling Units (SSU):** observation units

  - `\(y_{ij}\)`: measurement for unit `\(j\)` in cluster `\(i\)`
  
  - `\(M_i\)`: number of observation units in cluster `\(i\)`
  
  - `\(m_i \leq M_i\)`: number of sampled observation units in cluster `\(i\)`
  
  - `\(M_0 = \sum_{i=1}^N M_i\)`: total number of observation units in the population



---

## Example: California API scores

- A SRS of 40 school districts was selected from the 757 districts in the state.  Data from a SRS of schools within each selected district was collected. Design??



```r
&gt; glimpse(schools)
Rows: 126
Columns: 10
$ sname         &lt;chr&gt; "Alta-Dutch Flat Elementary", "Tenaya Elementary", "Pano~
$ snum          &lt;int&gt; 3269, 5979, 4958, 4957, 4956, 4915, 2548, 2550, 2549, 34~
$ dname         &lt;chr&gt; "Alta-Dutch Flat Elem", "Big Oak Flat-Grvlnd Unif", "Bri~
$ dnum          &lt;int&gt; 15, 63, 83, 83, 83, 117, 132, 132, 132, 152, 152, 152, 1~
$ api00         &lt;int&gt; 821, 773, 600, 740, 716, 811, 472, 520, 568, 591, 544, 6~
$ growth        &lt;int&gt; 36, 55, -32, 0, 5, 32, 40, 26, -21, 6, -10, 29, 14, 2, 3~
$ meals         &lt;int&gt; 27, 43, 33, 11, 5, 25, 78, 76, 68, 42, 63, 54, 0, 4, 1, ~
$ ell           &lt;int&gt; 0, 0, 5, 4, 2, 5, 38, 34, 34, 23, 42, 24, 3, 6, 2, 1, 37~
$ enroll        &lt;int&gt; 152, 312, 173, 201, 147, 234, 184, 512, 543, 332, 217, 5~
$ district_size &lt;int&gt; 1, 1, 3, 3, 3, 1, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 1, 4, 4,~
```

---

## Inclusion probabilities: Two-Stage Cluster 

What is the probability that unit `\(j\)` from cluster `\(i\)` is selected?
 

---

## Sampling weights:  Two-Stage Cluster 

What is the sampling weight for  unit `\(j\)` from cluster `\(i\)` under a one-stage cluster design?

---

## Estimation plan:  Two-Stage Cluster 

- **One option!** Use an **unbiased** Horvitz-Thompson estimator to estimate the (overall) **population total**

`$$\hat{t}_{HT} = \sum_{\textrm{sampled units}} w_{ij} y_{ij}$$`



---


## Population Total: Two-Stage Cluster 

- **Parameter**: `\(t = \sum_{i=1}^N \sum_{j=1}^{M_i} y_{ij}=  \sum_{i=1}^N t_i\)`

--

- **Unbiased Estimator:** 
`$$\hat{t}_{unb} =  \sum_{i =1}^{n}  \dfrac{N}{n} M_{i} \bar{y}_{i} = \sum_{i =1}^{n} \dfrac{N}{n} \hat{t}_{i}$$`
where `\(\hat{t}_i\)` is the *estimated * total response in cluster `\(i\)`.

--

- **Standard error:**
`$$SE(\hat{t}_{unb}) =  \sqrt{N^{2}\left(1- \dfrac{n}{N} \right) \dfrac{s^{2}_{t}}{n} + \dfrac{N}{n} \sum_{i=1}^n  \left(1- \dfrac{m_{i}}{M_{i}} \right) M_{i}^{2}\dfrac{s^{2}_{i}}{m_{i}} }$$`
where `\(s_t\)` is the sample standard deviation of *estimated* cluster totals and `\(s_i\)` is the sample SD within cluster `\(i\)`.

---


## Population Mean: Two-Stage Cluster 


- **Parameter**: `\(\bar{y}_{\mathcal{U}} = \dfrac{t}{M_0}\)`

--

- **Assume that `\(M_0\)` is known**

- **Unbiased Estimator:**
`$$\hat{\bar{y}}_{unb} = \dfrac{\hat{t}_{unb} }{M_{0}}$$`

--

- **Standard error:**
`$$SE(\hat{\bar{y}}_{unb}) = \dfrac{SE(\hat{t}_{unb})}{M_{0}}$$`


---


## Population Proportion: Two-Stage Cluster 


- **Parameter**: `\(p = \dfrac{t}{M_0}\)`

- Use formulas for mean where 

  - `\(\bar{y}_{i} = \hat{p}_{i}\)` is cluster sample proportion

  - `\(\hat{t}_{i}\)` estimates the number of observation units in cluster `\(i\)` that are a "success"
  
  - `\(s^{2}_{i}= \dfrac{m_{i}}{m_{i}-1}\hat{p}_{i}(1-\hat{p}_{i})\)`



---

## Example: California API scores




Estimate the number of schools that have over 50% of students who are eligible for a subsidized meal. 

```r
&gt; schools$meals_level &lt;- ifelse(schools$meals &gt; 50, "above 50%", "50% or below")
&gt; glimpse(schools)
Rows: 126
Columns: 11
$ sname         &lt;chr&gt; "Alta-Dutch Flat Elementary", "Tenaya Elementary", "Pano~
$ snum          &lt;int&gt; 3269, 5979, 4958, 4957, 4956, 4915, 2548, 2550, 2549, 34~
$ dname         &lt;chr&gt; "Alta-Dutch Flat Elem", "Big Oak Flat-Grvlnd Unif", "Bri~
$ dnum          &lt;int&gt; 15, 63, 83, 83, 83, 117, 132, 132, 132, 152, 152, 152, 1~
$ api00         &lt;int&gt; 821, 773, 600, 740, 716, 811, 472, 520, 568, 591, 544, 6~
$ growth        &lt;int&gt; 36, 55, -32, 0, 5, 32, 40, 26, -21, 6, -10, 29, 14, 2, 3~
$ meals         &lt;int&gt; 27, 43, 33, 11, 5, 25, 78, 76, 68, 42, 63, 54, 0, 4, 1, ~
$ ell           &lt;int&gt; 0, 0, 5, 4, 2, 5, 38, 34, 34, 23, 42, 24, 3, 6, 2, 1, 37~
$ enroll        &lt;int&gt; 152, 312, 173, 201, 147, 234, 184, 512, 543, 332, 217, 5~
$ district_size &lt;int&gt; 1, 1, 3, 3, 3, 1, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 1, 4, 4,~
$ meals_level   &lt;chr&gt; "50% or below", "50% or below", "50% or below", "50% or ~
```


---

## Example: California API scores


```r
&gt; schools_by_district &lt;- schools %&gt;% 
+   group_by(dnum) %&gt;%  # group by cluster (district number)
+   summarize(p_hat = mean(meals_level == "above 50%"), 
+             m_i = n(), # sample size per cluster
+             M_i = first(district_size), # pop size per cluster
+             t_hat_i = M_i*p_hat) %&gt;%
+   arrange(desc(M_i))   # arrange by big to small clusters
&gt; kable(schools_by_district, digits = 2)
```



| dnum| p_hat| m_i| M_i| t_hat_i|
|----:|-----:|---:|---:|-------:|
|  620|  1.00|   5|  72|    72.0|
|  570|  0.80|   5|  36|    28.8|
|  575|  0.00|   5|  28|     0.0|
|  638|  0.40|   5|  14|     5.6|
|  200|  1.00|   5|  11|    11.0|
|  731|  0.20|   5|   9|     1.8|
|  596|  0.00|   5|   7|     0.0|
|  639|  0.00|   5|   7|     0.0|
|  781|  0.00|   5|   6|     0.0|
|  295|  0.00|   5|   5|     0.0|
|  403|  0.00|   5|   5|     0.0|
|  480|  0.40|   5|   5|     2.0|
|  534|  0.60|   5|   5|     3.0|
|  549|  0.00|   5|   5|     0.0|
|  173|  0.00|   4|   4|     0.0|
|  198|  1.00|   4|   4|     4.0|
|  302|  0.00|   4|   4|     0.0|
|  452|  0.75|   4|   4|     3.0|
|  679|  0.00|   4|   4|     0.0|
|   83|  0.00|   3|   3|     0.0|
|  132|  1.00|   3|   3|     3.0|
|  152|  0.67|   3|   3|     2.0|
|  687|  0.00|   3|   3|     0.0|
|  228|  1.00|   2|   2|     2.0|
|  523|  0.00|   2|   2|     0.0|
|  552|  0.00|   2|   2|     0.0|
|  674|  0.00|   2|   2|     0.0|
|  701|  1.00|   2|   2|     2.0|
|  711|  0.00|   2|   2|     0.0|
|  768|  1.00|   2|   2|     2.0|
|   15|  0.00|   1|   1|     0.0|
|   63|  0.00|   1|   1|     0.0|
|  117|  0.00|   1|   1|     0.0|
|  176|  0.00|   1|   1|     0.0|
|  264|  0.00|   1|   1|     0.0|
|  456|  1.00|   1|   1|     1.0|
|  574|  0.00|   1|   1|     0.0|
|  719|  0.00|   1|   1|     0.0|
|  742|  0.00|   1|   1|     0.0|
|  795|  1.00|   1|   1|     1.0|


---

## Example: California API scores

Estimate the number of schools that have over 50% of students who are eligible for a subsidized meal. 


```r
&gt; N &lt;- 757  # number of clusters in pop
&gt; n &lt;- 40   # number of clusters sampled
&gt; schools_by_district %&gt;%
+   summarize(t_unb = (N/n)*sum(t_hat_i))
# A tibble: 1 x 1
  t_unb
  &lt;dbl&gt;
1 2729.
```

---

## Example: California API scores

But, we should be using the `survey` package instead:


```r
&gt; schools$N &lt;- 757  # N
&gt; schools$n &lt;- 40   # n 
&gt; schools &lt;- schools %&gt;%
+     group_by(dnum) %&gt;% # group by cluster (district number)
+     mutate(m_i = n())  #  m_i = sample size per cluster
&gt; summary(schools$m_i)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      1       3       5       4       5       5 
&gt; schools$wts &lt;- (757/40)*schools$district_size/schools$m_i
&gt; summary(schools$wts)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  18.93   18.93   18.93   40.70   26.50  272.52 
```


---

## Example: California API scores

But, we should be using the `survey` package instead:


```r
&gt; schools_design &lt;- svydesign(id= ~dnum + snum, 
+                             fpc= ~N + district_size, 
+                             weights = ~wts, 
+                             data=schools)
&gt; svytotal(~meals_level, schools_design, deff = TRUE)
                          total      SE    DEff
meals_level50% or below 2399.69  551.19  5.9451
meals_levelabove 50%    2728.99 1410.37 38.9246
```


---

## Population Mean: Two-Stage Cluster 


- **Parameter**: `\(\bar{y}_{\mathcal{U}} = \dfrac{t}{M_0}\)`

- **What if `\(M_0\)` is unknown!**


---


## Population Mean: Two-Stage Cluster 


- **Parameter**: `\(\bar{y}_{\mathcal{U}} = \dfrac{t}{M_0}\)`

--

- **Assume that `\(M_0\)` is unknown**

- **Biased Ratio Estimator:**
`$$\hat{\bar{y}} _{r} = \dfrac{ \sum_{i=1}^n \hat{t}_{i} }{ \sum_{i=1}^n M_{i} } = \dfrac{ \sum_{i =1}^n M_{i} \bar{y}_{i} }{ \sum_{i =1}^n M_{i} }$$`

--

- **Standard error:** for large `\(n\)`:

`$$SE(\hat{\bar{y}}_{r}) \approx \sqrt{\left( 1- \dfrac{n}{N}\right)  \dfrac{\sum_{i=1}^n (M_{i}\bar{y}_{i} - \hat{\bar{y}}_{r} M_{i})^{2}}{n \bar{M}^{2}(n-1)} + \dfrac{1}{nN\bar{M}^{2}} \sum_{i =1}^n  \left(1- \dfrac{m_{i}}{M_{i}} \right) M_{i}^{2}\dfrac{s^{2}_{i}}{m_{i}} }$$`


---


## Population Total: Two-Stage Cluster 


- **Parameter**: `\(t = M_0\bar{y}_{\mathcal{U}}\)`

- **Assume that `\(M_0\)` is known!!**

- **Biased Ratio Estimator:**
`$$\hat{t} _{r} = M_0\hat{\bar{y}} _{r}$$`

- **Standard error:** for large `\(n\)`
`$$SE(\hat{t}_{r}) \approx M_0 SE(\hat{\bar{y}}_{r})$$`

---

## Example: California API scores

Estimate the *proportion* of schools that have over 50% of students who are eligible for a subsidized meal. 


---

## Example: California API scores


```r
&gt; kable(schools_by_district, digits = 2)
```



| dnum| p_hat| m_i| M_i| t_hat_i|
|----:|-----:|---:|---:|-------:|
|  620|  1.00|   5|  72|    72.0|
|  570|  0.80|   5|  36|    28.8|
|  575|  0.00|   5|  28|     0.0|
|  638|  0.40|   5|  14|     5.6|
|  200|  1.00|   5|  11|    11.0|
|  731|  0.20|   5|   9|     1.8|
|  596|  0.00|   5|   7|     0.0|
|  639|  0.00|   5|   7|     0.0|
|  781|  0.00|   5|   6|     0.0|
|  295|  0.00|   5|   5|     0.0|
|  403|  0.00|   5|   5|     0.0|
|  480|  0.40|   5|   5|     2.0|
|  534|  0.60|   5|   5|     3.0|
|  549|  0.00|   5|   5|     0.0|
|  173|  0.00|   4|   4|     0.0|
|  198|  1.00|   4|   4|     4.0|
|  302|  0.00|   4|   4|     0.0|
|  452|  0.75|   4|   4|     3.0|
|  679|  0.00|   4|   4|     0.0|
|   83|  0.00|   3|   3|     0.0|
|  132|  1.00|   3|   3|     3.0|
|  152|  0.67|   3|   3|     2.0|
|  687|  0.00|   3|   3|     0.0|
|  228|  1.00|   2|   2|     2.0|
|  523|  0.00|   2|   2|     0.0|
|  552|  0.00|   2|   2|     0.0|
|  674|  0.00|   2|   2|     0.0|
|  701|  1.00|   2|   2|     2.0|
|  711|  0.00|   2|   2|     0.0|
|  768|  1.00|   2|   2|     2.0|
|   15|  0.00|   1|   1|     0.0|
|   63|  0.00|   1|   1|     0.0|
|  117|  0.00|   1|   1|     0.0|
|  176|  0.00|   1|   1|     0.0|
|  264|  0.00|   1|   1|     0.0|
|  456|  1.00|   1|   1|     1.0|
|  574|  0.00|   1|   1|     0.0|
|  719|  0.00|   1|   1|     0.0|
|  742|  0.00|   1|   1|     0.0|
|  795|  1.00|   1|   1|     1.0|

---

## Example: California API scores

Estimate the *proportion* of schools that have over 50% of students who are eligible for a subsidized meal. 


```r
&gt; N &lt;- 757  # number of clusters in pop
&gt; n &lt;- 40   # number of clusters sampled
&gt; schools_by_district %&gt;%
+   summarize(p_hat_r = sum(t_hat_i)/sum(M_i))
# A tibble: 1 x 1
  p_hat_r
    &lt;dbl&gt;
1   0.532
```


---

## Example: California API scores

But, we should be using the `survey` package instead:


```r
&gt; svymean(~meals_level, schools_design, deff = TRUE)
                           mean      SE DEff
meals_level50% or below 0.46790 0.14486 10.8
meals_levelabove 50%    0.53210 0.14486 10.8
```
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
